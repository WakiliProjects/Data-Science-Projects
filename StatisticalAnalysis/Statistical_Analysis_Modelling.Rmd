---
title: "Logistic Regression Analysis of Cornary Heart Disease Risk Factors"
author: "Mohammad Shahir Wakili"
output:
  pdf_document:
    toc: false
    latex_engine: xelatex
    number_sections: false
  word_document:
fontsize: 11pt
---



```{r _setup, include=FALSE}
# Global knit options: hide code by default (we'll selectively show some)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 7, fig.height = 5)

```


```{r}
library(tidyverse)
library(gridExtra)
library(pROC)
library(MASS) 
library(GGally)

```

## Data Preparation and Cleaning
Before analysis, the dataset was reviewed for completeness and consistency.  
Non-numeric columns were converted to the correct types, blank cells were treated as missing values, and rows containing only an ID were removed.  
This ensured that the data used in all analyses was accurate, complete, and ready for reliable modelling.


```{r, echo - FALSE, include = FALSE}
Heart <- read_csv("SA_Heart.csv")
```

```{r data-cleaning, include = FALSE}

head(Heart)
library(dplyr)
library(stringr)
library(naniar)
vis_miss(Heart)
sum(is.na(Heart))
colSums(is.na(Heart))
Heart <- na.omit(Heart)
sum(is.na(Heart))
colSums(is.na(Heart))
unique(Heart$famhist)
Heart %>%
  filter(if_any(everything(), ~ str_detect(as.character(.), "[^A-Za-z0-9.,/-]")))

Heart <- Heart %>%
  mutate(across(where(is.character), ~ str_replace_all(., "[^A-Za-z0-9 .,/-]","")))

Heart %>%
  filter(if_any(everything(), ~ str_detect(as.character(.), "[^A-Za-z0-9.,/-]")))

Heart <- Heart %>% drop_na()
Heart <- Heart %>%
  mutate(
    sbp = as.numeric(sbp),
    ldl = as.numeric(ldl),
    famhist = factor(famhist)  # keep famhist as categorical
  )
Heart <- Heart[rowSums(is.na(Heart))< ncol(Heart - 1),]
library(dplyr)

Heart <- Heart %>%
  filter(rowSums(!is.na(.)) > 1)
Heart 

```

```{r}

# --- Analysis note (visible in source):
# This chunk visualises the distribution to assess central tendency, spread,
# skewness, and potential outliers. Binning choices can change interpretation.
Heart$ID <- factor(Heart$ID)
Heart$chd <- factor(Heart$chd)
Heart$famhist <- factor(Heart$famhist)
Heart

```

### Interpretation — Data Overview Table

The dataset contains health and behavioural indicators for **462 male participants** from a high-risk region in Western Cape, South Africa.  
Out of these, **160 individuals (approximately 34.6%)** were diagnosed with **coronary heart disease (CHD)**. It includes **nine predictor variables** and **one binary response variable** (*chd*), capturing a range of biological, lifestyle, and hereditary risk factors.

Continuous predictors such as **systolic blood pressure (sbp)**, **tobacco consumption**, **LDL cholesterol**, **adiposity**, **obesity**, **alcohol intake**, and **age** represent quantifiable health and lifestyle measures. Categorical variables like **family history (famhist: Present/Absent)** and **CHD outcome** provide context for understanding genetic influence and disease occurrence.

This dataset offers a balanced mix of biological, behavioural, and genetic predictors, providing a solid foundation for logistic regression analysis. Key variables such as **LDL cholesterol**, **tobacco use**, and **age** are expected to show strong relationships with CHD, while **famhist** introduces a valuable categorical component for assessing inherited risk.  

Overall, the dataset supports a comprehensive investigation of how measurable health factors and lifestyle behaviours contribute to the likelihood of developing coronary heart disease.


```{r}
p1 <- ggplot(data = Heart, aes(x = sbp)) +
  geom_histogram(bins = 30, fill = "#4C78A8", color = "#1a1a1a", size = 0.25) +
  labs(title = "Systolic Blood Pressure\n(SBP)",  # wrap onto two lines
       x = "SBP (mm Hg)", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, margin = margin(b = 6)),
    panel.grid.minor = element_blank(),
    plot.margin = margin(6, 6, 6, 6)
  )

p2 <- ggplot(data = Heart, aes(x = tobacco)) +
  geom_histogram(bins = 30, fill = "#F58518", color = "#1a1a1a", size = 0.25) +
  labs(title = "Tobacco", x = "Tobacco (kg)", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p3 <- ggplot(data = Heart, aes(x = ldl)) +
  geom_histogram(bins = 30, fill = "#E45756", color = "#1a1a1a", size = 0.25) +
  labs(title = "LDL", x = "LDL", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p4 <- ggplot(data = Heart, aes(x = adiposity)) +
  geom_histogram(bins = 30, fill = "#72B7B2", color = "#1a1a1a", size = 0.25) +
  labs(title = "Adiposity", x = "Adiposity", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p5 <- ggplot(data = Heart, aes(x = typea)) +
  geom_histogram(bins = 30, fill = "#54A24B", color = "#1a1a1a", size = 0.25) +
  labs(title = "Type A Score", x = "Type A", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p6 <- ggplot(data = Heart, aes(x = obesity)) +
  geom_histogram(bins = 30, fill = "#EECA3B", color = "#1a1a1a", size = 0.25) +
  labs(title = "Obesity (BMI)", x = "BMI", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p7 <- ggplot(data = Heart, aes(x = alcohol)) +
  geom_histogram(bins = 30, fill = "#B279A2", color = "#1a1a1a", size = 0.25) +
  labs(title = "Alcohol", x = "Alcohol (current)", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

p8 <- ggplot(data = Heart, aes(x = age)) +
  geom_histogram(bins = 15, fill = "#FF9DA6", color = "#1a1a1a", size = 0.25) +
  labs(title = "Age", x = "Age (years)", y = "Count") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())

gridExtra::grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, ncol = 4)

```


### Histogram
The histogram shows that most observations are concentrated around the central range, indicating a clear midpoint where typical values occur. A visible right skew reveals that a smaller group of participants record unusually high values compared to the majority, suggesting that while most individuals remain within normal levels, a few exhibit elevated measurements that could increase their likelihood of developing coronary heart disease (CHD). This imbalance suggests the presence of outliers or high-risk cases that pull the mean upward even though the median remains near the central mass.

Overall, the distribution is not perfectly symmetric, reflecting real-world variability and reinforcing that higher values on this variable may be associated with greater CHD risk.


```{r}
b1 <- ggplot(Heart, aes(x = famhist, fill = famhist))+
  geom_bar(color = "black", size = 0.5)+
  scale_fill_manual(
    values = c(
      "Absent" = "pink",
      "Present" = "magenta"
    )
    
  ) +
  labs(title = "Family History of Heart Disease", x = "famhist", y = "Count", fill = "Status") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.minor = element_blank()
  )

b2 <- ggplot(
  Heart,
  aes(x = factor(as.character(chd), levels = c("0","1"), labels = c("No CHD","CHD")),
      fill = factor(as.character(chd), levels = c("0","1"), labels = c("No CHD","CHD")))
) +
  geom_bar(color = "black", size = 0.5) +
  scale_fill_manual(values = c("No CHD" = "pink", "CHD" = "magenta")) +
  labs(title = "CHD Outcome", x = "Outcome", y = "Count", fill = "Outcome") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        panel.grid.minor = element_blank())



gridExtra::grid.arrange(b1,b2)

```

### Bar Plot — Categorical Distribution

The **bar plot** demonstrates clear differences between the categories.  
One category shows a **noticeably higher frequency**, representing the majority of individuals in the dataset, while the **smaller group**, though less common, may be **linked to an increased likelihood of CHD**.

This indicates that certain **behavioural or hereditary traits** occur more frequently across the population, while others, though rarer, may **carry higher health risk**.

Overall, the plot provides an accessible view of **categorical variation** and highlights areas where **risk patterns** may emerge.


```{r}
hearting <- Heart %>%
  dplyr::select(sbp, tobacco, ldl, adiposity, typea, obesity, alcohol, age)

```

```{r ggpairs, echo=FALSE, warning=FALSE, message=FALSE}
ggpairs(
  hearting,
  title = "Pair Plot of Continuous Predictors — SA_Heart Dataset",
  upper = list(continuous = wrap("cor", size = 3, color = "#2F5597")),
  lower = list(continuous = wrap("points", alpha = 0.6, color = "#5A9BD5")),
  diag = list(continuous = wrap("densityDiag", fill = "#A1C3D1", alpha = 0.7))
) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

### Interpretation -  Pair Plot
The pair plot shows that certain variables, such as LDL cholesterol, adiposity, and obesity, move closely together, indicating strong positive correlations. This suggests the presence of multicollinearity, where several predictors share overlapping information in explaining CHD outcomes. High multicollinearity can reduce the reliability of coefficient estimates, making it harder to determine which variable truly influences CHD risk. Reducing the model by keeping only the most distinct and relevant predictors helps prevent this issue and ensures each retained variable contributes unique information. Overall, the relationships visible in the pair plot reveal meaningful connections between health indicators while highlighting the need for model simplification to maintain accuracy and interpretability.


```{r}
# ---- Boxplots by family history (separate plots) ----
library(ggplot2)
library(purrr)
library(gridExtra)

vars <- c("sbp","tobacco","ldl","adiposity","typea","obesity","alcohol","age")

mk_box <- function(var) {
  ggplot(Heart, aes(x = famhist, y = .data[[var]], fill = famhist)) +
    geom_boxplot(width = 0.6, alpha = 0.85,
                 outlier.shape = 21, outlier.fill = "white", outlier.color = "#D9534F") +
    scale_fill_manual(values = c(Absent = "#5A9BD5", Present = "#A1C3D1")) +
    labs(title = var, x = "Family History (famhist)", y = NULL) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      legend.position = "none",
      panel.grid.minor = element_blank()
    )
}

plots <- map(vars, mk_box)
grid.arrange(grobs = plots, ncol = 4)
```

### Interpretation — Box Plot
The box plot illustrates how the numerical variable differs across categories by showing the median, variability, and any outliers. A noticeable difference in the median levels between groups indicates that one category generally records higher values, suggesting a potential relationship with CHD risk.

A wider spread or longer whiskers in one group point to greater variability, meaning that individuals in that category experience more diverse outcomes.  
Outliers beyond the whiskers highlight a few extreme cases that may affect the overall trend.  
Overall, the box plot clearly visualises group differences and supports identifying which variables show distinct separation relevant to CHD prediction.

```{r welch-test, echo=FALSE, results='hide'}
Heart$famhist <- recode(Heart$famhist, 'Present' = 1, 'Absent' = 0) 


t.test(Heart$sbp ~ Heart$famhist)
t.test(Heart$tobacco ~ Heart$famhist) 

t.test(Heart$ldl ~ Heart$famhist)
t.test(Heart$adiposity ~ Heart$famhist)
t.test(Heart$typea ~ Heart$famhist)
t.test(Heart$obesity ~ Heart$famhist)
t.test(Heart$alcohol ~ Heart$famhist)
t.test(Heart$age ~ Heart$famhist)



```

### Interpretation — Welch *t*-Test

The Welch *t*-Test results reveal statistically significant differences between participants with and without a family history of heart disease across several key predictors.
LDL cholesterol (p = 0.0005), adiposity (p < 0.001), obesity (p = 0.013), and age (p < 0.001) all fall below the 0.05 threshold, confirming meaningful differences between the two groups.
These findings indicate that individuals with a family history of CHD tend to be older, have higher cholesterol levels, and show greater body fat, reinforcing the significance of these biological risk indicators.
In contrast, systolic blood pressure (p = 0.065), tobacco use (p = 0.052), alcohol consumption (p = 0.098), and type A behaviour (p = 0.334) were not statistically significant, suggesting that lifestyle-related behaviours have a weaker association with family history in this dataset.
Overall, the significant predictors emphasise that hereditary and metabolic factors contribute more strongly to coronary heart disease than behavioural factors in this population sample.

```{r, echo= FALSE}
fit1 <- glm(chd ~ tobacco + ldl + typea + age, data = Heart, family = "binomial")

```


```{r}


fit1
A1 <- AIC(fit1)

fit2 <- glm(chd ~ tobacco, data = Heart, family = "binomial")
A2 <- AIC(fit2)

fit3 <- glm(chd ~ ldl, data = Heart, family = "binomial")
A3 <- AIC(fit3)

fit4 <- glm(chd ~ typea, data = Heart, family = "binomial")
A4 <- AIC(fit4)

fit5 <- glm(chd ~ age, data = Heart, family = "binomial")
A5 <- AIC(fit5)

cat("The AIC values are:", A1,A2,A3,A4,A5)

```
### Interpretation — Logistic Regression Model
The logistic regression model was reduced to include tobacco, LDL cholesterol, type A behaviour, and age, as this combination achieved the lowest AIC value (502.09) compared with the other single-variable models, which ranged from approximately 529 to 595. Reducing the model helped identify the most effective set of predictors that explain the variation in coronary heart disease (CHD) outcomes without adding unnecessary complexity. A lower AIC (Akaike Information Criterion) value indicates a more optimal model that fits the data well while penalising excess variables. By removing weaker predictors, the model avoids overfitting and becomes more reliable for interpretation and prediction. Higher values of tobacco, LDL, type A score, and age increase the likelihood of CHD, confirming their importance as key predictors.

The reduced model captures the most influential variables while maintaining simplicity and accuracy. It provides a clear analytical view of how behavioural and biological factors jointly influence CHD risk, making it both statistically sound and practically relevant for further research or decision-making.


```{r}
#create new dataframe but with only the best fitted model & chd


summary(fit1)
fit1 <- glm(chd ~ tobacco + ldl + typea + age, data = Heart, family = "binomial")
newdata <- data.frame(tobacco = Heart$tobacco, ldl = Heart$ldl, 
                      typea = Heart$typea, age = Heart$age, chd = Heart$chd)
probabilities <- fit1 %>% predict(newdata, type = "response")
predicted <- ifelse(probabilities > 0.5, "chd", "healthy patient")
chd0 <- newdata$chd
chd0 <- as.numeric(as.character(chd0))
observed <- ifelse(chd0 >0.5, "chd", "healthy patient")
newdata$chd <- factor(newdata$chd)

xtabs(~observed+predicted,data=newdata)
summary(fit1)
```



```{r}

#using pryor probability 
160/462
fit1 <- glm(chd ~ tobacco + ldl + typea + age, data = Heart, family = "binomial")
newdata <- data.frame(tobacco = Heart$tobacco, ldl = Heart$ldl, 
                      typea = Heart$typea, age = Heart$age, chd = Heart$chd)
probabilities <- fit1 %>% predict(newdata, type = "response")
predicted1 <- ifelse(probabilities > 0.3463203, "chd", "healthy patient")
chd0 <- newdata$chd
chd0 <- as.numeric(as.character(chd0))
observed1 <- ifelse(chd0 >0.5, "chd", "healthy patient")
newdata$chd <- factor(newdata$chd)

xtabs(~observed1+predicted1,data=newdata)

summary(fit1)
```
### Interpretation — Model Evaluation with Prior Probability
The logistic regression model was evaluated using two classification thresholds to assess how the predicted probabilities align with actual CHD outcomes. Initially, a default cutoff of 0.5 was applied to classify individuals as having CHD or being healthy. However, this threshold does not reflect the actual distribution of the outcome in the dataset, where 160 out of 462 participants (approximately 0.346) were diagnosed with CHD.

To improve classification realism, the model was recalibrated using this prior probability (0.346) as the new cutoff. This adjustment accounts for the true prevalence of CHD and reduces potential bias from using an arbitrary threshold. The updated confusion matrix better represents the dataset by increasing the model’s sensitivity to correctly identify CHD cases while maintaining reasonable specificity for healthy individuals. The summary of the model confirms that tobacco, LDL cholesterol, type A behaviour, and age remain statistically significant, each contributing to higher CHD risk.  
The model’s AIC value of 502.09 continues to indicate a strong fit, showing that the reduced model effectively captures key predictors without unnecessary complexity.  
Overall, applying the prior probability threshold enhances the model’s interpretability and classification accuracy.It ensures predictions align more closely with real-world prevalence, demonstrating a balanced, data-driven approach that strengthens the model’s reliability for both analytical and practical decision-making.

```{r}
library(pROC)
prob_look <- predict(fit1, newdata, type = "response")
roc_look <- roc(newdata$chd ~ prob_look)
par(pty = "s")
plot(roc_look, grid = TRUE, legacy.axes = TRUE, plot = TRUE, print.auc = TRUE)
```

### Interpretation — ROC Curve
The ROC (Receiver Operating Characteristic) curve evaluates the model’s ability to correctly distinguish between individuals with and without coronary heart disease (CHD) across all probability thresholds. The curve shows a strong balance between sensitivity and specificity, indicating that the model can effectively identify true CHD cases while minimising false classifications.  

The **AUC (Area Under the Curve)** value of **0.772** reflects solid predictive performance, meaning that the model ranks CHD-positive individuals higher than CHD-negative ones roughly 77 percent of the time. This level of accuracy suggests the model has meaningful discriminatory power and performs reliably in separating risk groups within the dataset.  

In practical terms, this demonstrates that the selected predictors — **tobacco use**, **LDL cholesterol**, **type A behaviour**, and **age** — collectively contribute to a model that is both statistically sound and applicable for data-driven health risk assessment.  
Overall, the ROC curve confirms the model’s capability to provide consistent, interpretable predictions that support informed analytical and decision-making processes.